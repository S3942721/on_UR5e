# Dockerfile for UR5e ROS2 Moveit build environment
# (Alterable for generic ROS2 development)
# Author: 		Sam Griffiths
# Base Dockerfile: 	Jasper Avice Demay
# Last Updated: 	11/4/2024

# Base image
FROM ros:humble

# General environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=en_AU.UTF-8
ENV LANGUAGE=en_AU:en
ENV LC_ALL=en_AU.UTF-8
LABEL maintainer="Sam Griffiths sam.griffiths@rmit.edu.au"

# Workspace variables
ENV HOME /root
ENV UNDERLAY_WS $HOME/underlay_ws
ENV OVERLAY_WS $HOME/overlay_ws

# Update package lists and upgrade existing packages
RUN apt-get update && apt-get -y upgrade

# Install locales and generate en_AU.UTF-8 locale
RUN apt-get update && apt-get install -y locales && \
    locale-gen en_AU.UTF-8 && \
    update-locale LC_ALL=en_AU.UTF-8 LANG=en_AU.UTF-8

# Install basic utilities
RUN apt-get update && apt-get install -y nano curl software-properties-common git

# Add ROS 2 repository and install ROS 2 packages
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null && \
    apt-get update && apt-get -y upgrade && \
    apt-get install -y ros-humble-desktop ros-humble-xacro ros-humble-urdfdom-py ros-humble-ros-testing ros-humble-moveit-msgs ros-humble-graph-msgs ros-humble-rviz-visual-tools ros-humble-object-recognition-msgs ros-humble-geometric-shapes ros-humble-joint-state-publisher ros-humble-control-msgs ros-humble-ompl ros-humble-ament-clang-format ros-humble-warehouse-ros ros-humble-generate-parameter-library ros-humble-backward-ros ros-humble-controller-manager-msgs ros-humble-controller-manager ros-humble-gripper-controllers ros-humble-joint-state-broadcaster ros-humble-joint-trajectory-controller ros-humble-ros2-control ros-humble-control-toolbox ros-humble-position-controllers ros-humble-eigen-stl-containers ros-humble-octomap-msgs ros-humble-random-numbers ros-humble-ruckig ros-humble-joint-state-publisher-gui

# Install Python dependencies
RUN apt-get update && apt-get install -y python3-rosdep python3-colcon-common-extensions python3-colcon-mixin python3-vcstool

# Install additional dependencies
RUN apt-get update && apt-get install -y freeglut3-dev libomp-dev libfcl-dev
RUN apt-get update && apt-get install -y python3-colcon-mixin
RUN apt-get update && colcon mixin add default https://raw.githubusercontent.com/colcon/colcon-mixin-repository/master/index.yaml
RUN colcon mixin update default

# Set up ROS workspace and clone MoveIt2 tutorials
#ENV HOME /root
RUN mkdir -p $UNDERLAY_WS/src && \
    cd $UNDERLAY_WS/src && \
    git clone --branch humble https://github.com/ros-planning/moveit2_tutorials && \
    vcs import < moveit2_tutorials/moveit2_tutorials.repos

# Build the workspace
WORKDIR $UNDERLAY_WS
RUN /bin/bash -c "source /opt/ros/humble/setup.bash; colcon build --mixin release"

## Start Overlay Workspace Setup ##

# Create and initialize the overlay workspace
#ENV OVERLAY_WS $HOME/overlay_ws
RUN mkdir -p $OVERLAY_WS/src && \
    /bin/bash -c "source $UNDERLAY_WS/install/setup.bash; \
                  cd $OVERLAY_WS; \
                  colcon build --mixin release"

# Add source command for the underlay and overlay workspace to .bashrc to ensure it's sourced on new sessions
# The order here is important
RUN echo "source $UNDERLAY_WS/install/setup.bash" >> /etc/bash.bashrc
RUN echo "source $OVERLAY_WS/install/setup.bash" >> /etc/bash.bashrc

## End Overlay Workspace Setup ##
# Setup for ssh onto github
ENV SSH_KEY_LOCATION deploy_key
RUN mkdir -p /root/.ssh
ADD $SSH_KEY_LOCATION /root/.ssh/id_rsa
RUN chmod 700 /root/.ssh/id_rsa
RUN echo "Host github.com\n\tStrictHostKeyChecking no\n" >> /root/.ssh/config

## ROBOT SPECIFIC CHANGES ##
# Version control variables
# ***CHANGE THIS IF WORKING FROM DIFFERENT GH BRANCH***
ENV WORKING_BRANCH main
ENV REPO_URL git@github.com:S3942721/on_UR5e.git

# Install Universal Robotics package
RUN apt-get update --fix-missing && apt-get install -y ros-humble-ur

# Install network tools
RUN apt-get update -y && apt-get install -y iputils-ping

# Expose port 50002
EXPOSE 50002

# Do not cache from this point onwards:
ARG CACHEBUST="unknown"

# Clone additional packages into the overlay workspace src directory
WORKDIR $OVERLAY_WS/src
 	RUN git clone -b $WORKING_BRANCH --single-branch $REPO_URL .

# Default command to run bash shell
CMD ["/bin/bash"]

